---
domain: rg.cape.io # This is the cache CNAME used for the virtual server on the compile server. CNAME that domain to cache.cape.io and it will serve the compiled website.
uid: 1 # The CAPE user ID to use for authenticating against the providers when requesting API resources. This needs to be updated to the correct uid.
cape_version: 2.0.5 # Current version of cape can be found in Kai's head. Future at v2.cape.io/version

load:
  - "http://v2.cape.io/rg/_api/items/_load.json"
  - "http://v2.cape.io/rg/_api/items/_update.json"
  - "http://v2.cape.io/rg/_model/items/model_fields_add.json"
  - "http://v2.cape.io/rg/_model/files/model_fields_reload.json"
  - "http://v2.cape.io/rg/_view/_all/process.json"

api: # An API as a collection of content.

  old_demo: # Used to get content from old github repo.
    provider: github
    arg:
      owner: ookb
      repo: rogersgoffigon
      branch: gh-pages
    load: # To load previously created content from this API you need to specificy the load param.
      resource: tree # Github has a nice index of all content in a repo.
      _id: path
      arg:
        recursive: true # Thankfully they have an option to get results recursively.
        sha: gh-pages

  gh_repo: # Used to get content from the big heavy github repo.
    provider: github
    arg:
      owner: bjornmeansbear
      repo: rogers-and-goffigon
      branch: master
    load:
      resource: tree
      _id: path
      arg:
        recursive: true
        sha: master
    field:
      template:
        resource: raw_api
        type: yaml_front
        default: default.html
        arg:
          path: 'templates/{{&id}}'

  # An API defined for accepting posts.
  items: # Get item content from a json file.
    provider: post
    arg:
      id: rg
      source: pdf_csv
    load:
      provider: wget
      resource: json
      _id: itemnum
      arg:
        url: http://rg.cape.io/items/index_full.json
      field:
        _source: _self

model:

  files:
    type: files
    filter:
      api: gh_repo
      should:
        _ext: ['.jpg', '.jpeg', '.png', '.css', '.js', '.ico', '.gif', '.html', '.ttf']
      must_not:
        _dir1: reference
    file:
      source_file:
        api: gh_repo
        resource: raw_api
        file_id: '{{&_id}}'
        type: any
        arg:
          path: '{{&_id}}'

  items:
    type: list
    filter:
      api: items
    field:
      parent_id: '{{&_id}}'
      img:
        provider: wget
        resource: json
        arg:
          url: 'http://v2.cape.io/rg/img?itemid={{&_id}}'
      # Special field will save FULL object to a file.
      # Added to the entity to make it always clear where all the fields are stored.
      # This prevents saving the object to other places in other models.
      _file_id: 'items/{{&_id}}/info.json'
    map:
      parent_id: last_dash_rm
    file:
      normal_320:
        file_id: 'items/{{&_id}}/normal_320{{img.normal.ext}}'
        provider: wget
        resource: raw
        arg:
          url: 'http://{{img.normal.domain}}.img.cape.io/320x320{{&img.normal.path}}'
      normal_640:
        file_id: 'items/{{&_id}}/normal_640{{img.normal.ext}}'
        provider: wget
        resource: raw
        arg:
          url: 'http://{{img.normal.domain}}.img.cape.io/640x640{{&img.normal.path}}'
      normal_1024:
        file_id: 'items/{{&_id}}/normal_1024{{img.normal.ext}}'
        provider: wget
        resource: raw
        arg:
          url: 'http://{{img.normal.domain}}.img.cape.io/1024x1024{{&img.normal.path}}'
      normal_1536:
        file_id: 'items/{{&_id}}/normal_1536{{img.normal.ext}}'
        provider: wget
        resource: raw
        arg:
          url: 'http://{{img.normal.domain}}.img.cape.io/1536x1536{{&img.normal.path}}'

  textile:
    type: list
    filter:
      api: items
      must:
        _char1int: true
    field:
      collection: textile
    file:
      far_320:
        file_id: 'items/{{&_id}}/far_320{{img.far.ext}}'
        provider: wget
        resource: raw
        arg:
          url: 'http://{{img.far.domain}}.img.cape.io/320x320{{&img.far.path}}'
      far_640:
        file_id: 'items/{{&_id}}/far_640{{img.far.ext}}'
        provider: wget
        resource: raw
        arg:
          url: 'http://{{img.far.domain}}.img.cape.io/640x640{{&img.far.path}}'
      far_1024:
        file_id: 'items/{{&_id}}/far_1024{{img.far.ext}}'
        provider: wget
        resource: raw
        arg:
          url: 'http://{{img.far.domain}}.img.cape.io/1024x1024{{&img.far.path}}'
      far_1536:
        file_id: 'items/{{&_id}}/far_1536{{img.far.ext}}'
        provider: wget
        resource: raw
        arg:
          url: 'http://{{img.far.domain}}.img.cape.io/1536x1536{{&img.far.path}}'

  passementerie:
    type: list
    filter:
      api: items
      must:
        _char1: P
    field:
      collection: passementerie

  leather:
    type: list
    filter:
      api: items
      must:
        _char1: L
    field:
      collection: leather

  pages:
    type: list
    filter:
      api: gh_repo
      must:
        _dirname: content

view:
  #items:

  login:
    type: string
    file_id: login/index.html
    field:
      theme:
        provider: wget
        resource: json
        arg:
          url: http://db.cape.io/data/rg/theme
      timestamp:
        provider: wget
        resource: json
        arg:
          url: https://timestamp.webscript.io/
    template:
      api: gh_repo
      resource: raw_api
      arg:
        path: login/index.html

  pricelist:
    type: string
    file_id: trade/pricelist.html
    field:
      theme:
        provider: wget
        resource: json
        arg:
          url: http://db.cape.io/data/rg/theme
    template:
      api: gh_repo
      resource: raw_api
      arg:
        path: trade/pricelist.html

  upload:
    type: string
    file_id: admin/index.html
    field:
      theme:
        provider: wget
        resource: json
        arg:
          url: http://db.cape.io/data/rg/theme
    template:
      api: gh_repo
      resource: raw_api
      arg:
        path: admin/index.html

  plist_pre:
    type: string
    file_id: trade/pricelist_compiled.html
    field:
      items: price_list
      theme:
        provider: wget
        resource: json
        arg:
          url: http://db.cape.io/data/rg/theme
    template:
      api: gh_repo
      resource: raw_api
      arg:
        path: trade/pricelist_compiled.html

  price_list:
    type: list
    output_id: trade/pricelist.json
    field:
      items: true
    pager:
      iterate: items
      field_id: item
    emit:
      name: '{{&item.descript_1}}'
      color: '{{&item.descript_2}}'
      id: '{{&item._id}}'
      content: '{{&item.content}}'
      repeat: '{{&item.repeat}}'
      width: '{{&item.width}}'
      price: '{{&item.price}}'

  collection:
    type: list
    output_id: items/items.json
    field:
      items: true
    pager:
      iterate: items
      field_id: item
    emit:
      name: '{{&item.descript_1}}'
      color: '{{&item.descript_2}}'
      id: '{{&item._id}}'
      content: '{{&item.content}}'
      repeat: '{{&item.repeat}}'
      width: '{{&item.width}}'
      img: 'http://rg.cape.io/{{&item._file.normal_640}}'
