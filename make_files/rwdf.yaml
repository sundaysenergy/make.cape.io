---
domain: www.rwdfoundation.org # This is not used for anything yet.
cdn: www.rwdfoundation.org
uid: kc2 # The CAPE user ID to use for authenticating against the providers when requesting API resources.
cape_version: 2.1.7

api: # An API is just a set of default information.
  cloudfiles: # Used for uploads to the CDN used for the website.
    provider: cloudfiles
    arg:
      container: www.rwdfoundation.org

  gh_theme: # Used to get theme from github.
    provider: github
    arg:
      repo: rwdf-site-theme
      owner: bjornmeansbear
      branch: master
    load: # To load previously created content from this API you need to specificy the load param.
      resource: tree # Github has a nice index of all content in a repo.
      _id: path
      arg:
        recursive: true
        sha: master

  content:
    provider: dropbox
    arg:
      root: dropbox
      path_prefix: /rwdf-site-content
    load:
      resource: delta
      _id: path
      arg:
        cursor: ''

model:
  files:
    type: files
    filter:
      api: content
      should:
        _ext: ['.jpg', '.jpeg', '.png', '.css', '.js', '.ico', '.gif', '.html', '.ttf', '.pdf']
    file:
      source_file:
        api: content
        resource: files
        file_id: '{{&_id}}'
        type: any
        arg:
          root: dropbox
          path: '{{path}}'

  files2:
    type: files
    filter:
      api: gh_theme
      should:
        _ext: ['.jpg', '.jpeg', '.png', '.css', '.js', '.ico', '.gif', '.html', '.ttf', '.pdf']
    file:
      source_file:
        api: gh_theme
        resource: raw
        file_id: '{{&_id}}'
        type: any
        arg:
          path: '{{&_id}}'

  data:
    type: set
    set_key: _no_ext
    filter:
      api: content
      must:
        _filename: data
      should:
        _ext: ['.yaml', '.yml']
    field:
      _self: # _self is a special meta-field that will place its own fields within the base context.
        file_id: '{{_no_ext}}.json' # When the _file field has a value it saves that field as a file.
        api: content # The _self field is processed first.
        resource: files # This just defines what API at github to use.
        type: yaml # This tells CAPE what to do with the file that it gets. This should default to the file extension.
        arg:
          root: dropbox
          path: '{{path}}'

  pages:
    type: object
    filter:
      api: content
      must:
        _id: pages.yaml
    field:
      _self: # _self is a special meta-field that will place its own fields within the base context.
        file_id: '{{_no_ext}}.json' # When the _file field has a value it saves that field as a file.
        api: content # The _self field is processed first.
        resource: files # This just defines what API at github to use.
        type: yaml # This tells CAPE what to do with the file that it gets. This should default to the file extension.
        arg:
          root: dropbox
          path: '{{path}}'

  page_info:
    type: set
    set_key: _dirname
    filter:
      api: content
      should:
        _ext: ['.yaml', '.yml']
      must:
        _filename: page_info
    field:
      _self: # _self is a special meta-field that will place its own fields within the base context.
        file_id: '{{_no_ext}}.json' # When the _file field has a value it saves that field as a file.
        api: content # The _self field is processed first.
        resource: files # This just defines what API at github to use.
        type: yaml # This tells CAPE what to do with the file that it gets. This should default to the file extension.
        arg:
          root: dropbox
          path: '{{path}}'

  content:
    type: ezle
    filter:
      api: content
      must:
        _ext: .md
    field: # The base "entity" in CAPE is the _id field. That's it.
      # To get the contents of the file we need to add a "meta-field"
      _self: # _self is a special meta-field that will place its own fields within the base context.
        api: content # The _self field is processed first.
        resource: files # This just defines what API at github to use.
        type: md # This tells CAPE what to do with the file that it gets. This should default to the file extension.
        arg:
          root: dropbox
          path: '{{path}}'
      teaser:
        app: map
        func: prune
        arg:
          string: '{{&content}}'
          stripTags: true
          length: 110

  template:
    filter:
      api: gh_theme
      must:
        _dirname: templates
    field:
      _self:
        api: gh_theme
        resource: raw
        type: yaml_front
        default: default.html
        arg:
          path: '{{&_id}}'

  news:
    filter:
      api: content
      must:
        _dir2: articles
        _ext: .md
    field:
      date:
        app: map
        func: date_from_string
        arg:
          string: '{{_file_slug}}'
          start: 0
          end: 10
          display: 'MMM DD, YYYY'

view:
  content:
    type: set
    field:
      content:
        model: content

  index:
    type: string
    field:
      content: true
      data: true
      page_info: true
      front:
        api_id: content
        index_type: list
        index_id: homepage
        index_by: _i
    file_id: index.html
    template:
      model: template
      _id: default.html
      partial:
        page_html:
          model: template
          _id: homepage.html

  pages:
    type: string
    field:
      content: true
      data: true
      page_info: true
      pages:
        model: data
        emit: data.pages
    pager:
      iterate: pages
      field_id: page
      ezle: true
      template:
        partial:
          page_html:
            model: template
            _id: "{{page._id}}.html"
      file_id: "{{page._id}}/index.html"
    template:
      model: template
      _id: default.html

  projects:
    type: string
    field:
      data: true
      projects:
        model: content
        emit: whatwedo.projects._all
      spruceups:
        model: content
        emit: whatwedo.projects.spruceups._all
    pager:
      iterate: projects
      field_id: page
      file_id: "whatwedo/{{page._filename}}/index.html"
      bool_field_id: _filename
    template:
      model: template
      _id: default.html
      partial:
        page_html:
          model: template
          _id: project.html

  client_data:
    type: list
    field:
      all_projects:
        model: content
        emit: whatwedo.projects._all
        pluck: [image, featureimg, featuretitle, title, featureblurb, _filename, _id, date, summary]
        index_by: _id
      featured_projects:
        api_id: content
        index_type: list
        index_id: homepage
        field: entities
        index_by: id
    merge:
      field_id: projects
      sort: score
    output_id: whatwedo/projects.json

